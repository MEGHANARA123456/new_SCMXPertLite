<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SCMXpertLite ‚Äî Login / Signup</title>

  <!-- Fonts + libs -->
  <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,600' rel='stylesheet'>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>

  <!-- reCAPTCHA (v2) -->
  <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --purple:#673AB7;
      --purple-dark:#4A1CA0;
      --teal:#03C2E0;
      --bg:#f4f7fb;
      --card:#ffffffcc;
      --glass-border: rgba(255,255,255,0.6);
      --muted:#6b6b7a;
      --shadow: 0 14px 40px rgba(30,12,60,0.09);
      --accent: #6ac4ee;
      --left-width:120px;
      --max-card-width:960px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Roboto, system-ui, Arial, sans-serif;
      background: linear-gradient(180deg, #eef6fb 0%, #f9f8ff 100%);
      color:#222;
      -webkit-font-smoothing:antialiased;
      overflow:hidden;
      display:flex;
    }

    .left-strip{
      width:var(--left-width);
      min-width:var(--left-width);
      display:flex;
      align-items:center;
      justify-content:center;
      position:fixed;
      left:0; top:0; bottom:0;
      z-index:5;
      pointer-events:none;
    }
    .left-strip .brand{
      writing-mode: vertical-rl;
      transform: rotate(180deg);
      font-weight:800;
      letter-spacing:1px;
      color:#000;
      font-size:18px;
    }

    .page-wrap{
      margin-left:var(--left-width);
      width:calc(100% - var(--left-width));
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      height:100vh;
      overflow:auto;
    }

    .bg-anim{
      position:absolute;
      inset:0;
      overflow:hidden;
      z-index:0;
      pointer-events:none;
    }
    .blob{
      position:absolute;
      filter: blur(36px) saturate(120%);
      opacity:0.85;
      will-change: transform;
    }

    .card-wrap{
      position:relative;
      z-index:10;
      width:min(920px, 92%);
      max-width:var(--max-card-width);
      display:grid;
      grid-template-columns: 1fr 420px;
      gap: 20px;
      align-items:center;
      padding:28px;
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.55));
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px) saturate(120%);
    }

    .card-left{
      padding:18px 22px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .card-left h1{
      margin:0;
      color:var(--purple-dark);
      font-size:28px;
      font-weight:800;
    }
    .card-left p{
      margin:0;
      color:var(--muted);
      font-size:14px;
    }
    .features{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .feature{
      background: rgba(106,196,238,0.12);
      padding:8px 10px;
      border-radius:8px;
      font-weight:600;
      color:var(--purple-dark);
      font-size:13px;
    }

    .card-right{
      padding:18px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.8));
      box-shadow: 0 8px 28px rgba(46,17,84,0.04);
      border:1px solid rgba(0,0,0,0.03);
    }

    .tabs{ display:flex; gap:6px; margin-bottom:12px }
    .tab{
      flex:1;
      text-align:center;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      background:transparent;
      color:var(--muted);
    }
    .tab.active{
      background: linear-gradient(90deg,var(--purple),var(--accent));
      color:white;
    }

    .form-group{
      margin-bottom:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    label{
      font-size:12px;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:700;
    }

    input{
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #e6e6ee;
      background:transparent;
      font-size:14px;
    }

    .actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
    }

    .btn{
      padding:10px 12px;
      border-radius:8px;
      border:none;
      font-weight:800;
      color:white;
      background:var(--purple);
      cursor:pointer;
    }
    .btn.ghost{
      background:transparent;
      color:var(--purple);
    }

    #googleLoginBtn{
      display:flex;
      justify-content:center;
      margin:10px auto 0;
      width:100%;
    }

    .captcha-box{
      margin-top:10px;
      display:flex;
      justify-content:center;
    }

    #forgot-overlay{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      z-index:2000;
      align-items:center;
      justify-content:center;
    }
    #forgot-card{
      width:380px;
      background:white;
      padding:20px;
      border-radius:10px;
      box-shadow:0 8px 32px rgba(0,0,0,0.2);
    }
  </style>
</head>

<body>

<div class="left-strip">
  <div class="brand">SCMXpertLite</div>
</div>

<div class="page-wrap">

  <div class="bg-anim">
    <svg class="blob" style="left:-10%; top:5%; width:520px; height:520px;">
      <defs><linearGradient id="g1" x1="0" x2="1">
        <stop offset="0" stop-color="#6ac4ee"/>
        <stop offset="1" stop-color="#673AB7"/>
      </linearGradient></defs>
      <circle cx="50%" cy="50%" r="50%" fill="url(#g1)"/>
    </svg>

    <svg class="blob" style="right:-8%; bottom:-6%; width:620px; height:620px;">
      <defs><linearGradient id="g2" x1="0" x2="1">
        <stop offset="0" stop-color="#673AB7"/>
        <stop offset="1" stop-color="#03C2E0"/>
      </linearGradient></defs>
      <rect width="100%" height="100%" rx="180" fill="url(#g2)"></rect>
    </svg>
  </div>

  <div class="card-wrap">

    <div class="card-left">
      <h1>SCMXpertLite</h1>
      <p>Smarter shipment tracking, simple admin controls, and fast device telemetry ‚Äî built for teams.</p>

      <div class="features">
        <div class="feature">Shipments</div>
        <div class="feature">Device Data</div>
        <div class="feature">RBAC</div>
        <div class="feature">OTP & Email</div>
      </div>

      <p style="font-size:13px;color:#777">Sign up to try a sandbox account, or login if you already have credentials.</p>
      <div style="margin-top:auto;font-size:12px;color:#777">¬© SCMXpertLite</div>
    </div>

    <div class="card-right">

      <div style="display:flex; justify-content:space-between;">
        <div style="font-weight:800;color:var(--purple-dark)">Access</div>
        <div class="small">Secure login & signup</div>
      </div>

      <div class="tabs">
        <div class="tab active" id="tab-login">Login</div>
        <div class="tab" id="tab-signup">Sign up</div>
      </div>

      <!-- LOGIN FORM -->
      <form id="form-login">
        <div class="form-group">
          <label>Username or Email</label>
          <input id="username-login" type="text" required>
        </div>

        <div class="form-group">
          <label>Password</label>
          <div style="position:relative;">
            <input id="password-login" type="password" required>
            <span onclick="togglePassword('password-login', this)"
              style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;">
              üëÅÔ∏è
            </span>
          </div>
        </div>

        <div class="captcha-box">
          <div id="recaptcha-login"></div>
        </div>

        <!-- GOOGLE BUTTON -->
        <div id="googleLoginBtn"></div>

        <div class="actions">
          <button class="btn" id="btn-login" type="button">Log in</button>
          <button class="btn ghost" id="open-forgot-btn" type="button">Forgot?</button>
        </div>
      </form>

      <!-- SIGNUP FORM -->
      <form id="form-signup" style="display:none;">
        <div class="form-group">
          <label>Email</label>
          <input id="email-signup" type="email" required>
        </div>

        <div class="form-group">
          <label>Username</label>
          <input id="username-signup" type="text" required>
        </div>

        <div class="form-group">
          <label>Password</label>
          <div style="position:relative;">
            <input id="password-signup" type="password" required>
            <span onclick="togglePassword('password-signup', this)"
              style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;">üëÅÔ∏è</span>
          </div>
        </div>

        <div class="form-group">
          <label>Confirm Password</label>
          <div style="position:relative;">
            <input id="confirm-password-signup" type="password" required>
            <span onclick="togglePassword('confirm-password-signup', this)"
              style="position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;">üëÅÔ∏è</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btn-signup" type="button">Sign up</button>
          <div class="small">No reCAPTCHA on signup</div>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- FORGOT PASSWORD OVERLAY -->
<div id="forgot-overlay">
  <div id="forgot-card">
    <button id="forgot-close" style="float:right;background:none;border:0;font-size:18px;cursor:pointer;">‚úï</button>
    <h3>Reset Password</h3>

    <div id="fp-step-email">
      <label>Email</label>
      <input id="forgot-email" type="email">
      <button class="btn" id="forgot-send-otp" style="width:100%;margin-top:12px;">Send OTP</button>
    </div>

    <div id="fp-step-otp" style="display:none;">
      <label>Enter OTP</label>
      <input id="forgot-otp" maxlength="6">
      <button class="btn" id="forgot-verify-otp" style="width:100%;margin-top:12px;">Verify OTP</button>
    </div>

    <div id="fp-step-password" style="display:none;">
      <label>New password</label>
      <input id="forgot-new-password" type="password">

      <label>Confirm</label>
      <input id="forgot-confirm-password" type="password">

      <button class="btn" id="forgot-reset-btn" style="width:100%;margin-top:12px;">Reset Password</button>
    </div>
  </div>
</div>

<script>
/* ==========================
    PASSWORD TOGGLE
========================== */
function togglePassword(id, btn){
    const field = document.getElementById(id);
    field.type = field.type === "password" ? "text" : "password";
    btn.textContent = field.type === "password" ? "üëÅÔ∏è" : "üôà";
}

/* ==========================
    BASIC CONFIG
========================== */
const API_BASE_URL = `${location.protocol}//${location.hostname}:8000`;
const RECAPTCHA_SITE_KEY = "6LdxN8orAAAAAK_nUskDJoJbpyP3U2F23QqPh0Z-";

/* ==========================
    UI Switch Login/Signup
========================== */
function showLogin(){ $("#form-login").show(); $("#form-signup").hide(); $("#tab-login").addClass("active"); $("#tab-signup").removeClass("active"); }
function showSignup(){ $("#form-login").hide(); $("#form-signup").show(); $("#tab-signup").addClass("active"); $("#tab-login").removeClass("active"); }

$("#tab-login").on("click", showLogin);
$("#tab-signup").on("click", showSignup);

/* ==========================
    reCAPTCHA Loader
========================== */
let recaptchaLoginWidget = null;

function onRecaptchaLoad(){
  const interval = setInterval(() => {
    if(typeof grecaptcha !== "undefined" && document.getElementById("recaptcha-login")){
      clearInterval(interval);
      recaptchaLoginWidget = grecaptcha.render("recaptcha-login", {
        sitekey: RECAPTCHA_SITE_KEY
      });
    }
  }, 150);
}

/* ==========================
        LOGIN
========================== */
$("#btn-login").on("click", async function(){
  const username = $("#username-login").val().trim();
  const password = $("#password-login").val().trim();

  let token = "";
  if(recaptchaLoginWidget !== null){
    token = grecaptcha.getResponse(recaptchaLoginWidget);
  }

  const body = new URLSearchParams({ username, password, recaptcha_token: token });

  try{
    const res = await fetch(`${API_BASE_URL}/login`, { method:"POST", body });
    const json = await res.json();
    if(!res.ok) throw new Error(json.detail);

    localStorage.setItem("token", json.access_token);
    localStorage.setItem("username", json.username);
    localStorage.setItem("role", json.role);

    if(json.role === "admin") window.location.href = "/frontend/admin_dashboard.html";
    else window.location.href = "/frontend/dashboard.html";

  } catch(err){
    alert("Login failed: " + err.message);
  }
});

/* ==========================
        SIGNUP
========================== */
$("#btn-signup").on("click", async function(){
  const email = $("#email-signup").val().trim();
  const username = $("#username-signup").val().trim();
  const password = $("#password-signup").val();
  const confirm = $("#confirm-password-signup").val();

  if(password !== confirm){ alert("Passwords do not match"); return; }

  const body = new URLSearchParams({ email, username, password, confirm_password:confirm });

  try{
    const res = await fetch(`${API_BASE_URL}/signup`, { method:"POST", body });
    const json = await res.json();
    if(!res.ok) throw new Error(json.detail);

    alert("Signup successful. Please login.");
    showLogin();
  }
  catch(err){
    alert("Signup failed: " + err.message);
  }
});

/* ==========================
      GOOGLE SSO CLEAN BLOCK
========================== */

const GOOGLE_CLIENT_ID = "192553672532-6d99lu2hh454bmb9i5muf8g4si7ib6b3.apps.googleusercontent.com";

/* Google callback */
function handleGoogleCredential(response){
    console.log("[GSI] Token received", response);

    const idToken = response?.credential;
    if(!idToken){
        alert("Google login failed ‚Äî no credential");
        return;
    }

    fetch(`${API_BASE_URL}/auth/google`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
            token:idToken,
            recaptcha_token:""
        })
    })
    .then(res => res.json().then(data => ({ ok:res.ok, data })))
    .then(result => {
        if(!result.ok){
            alert(result.data.detail || "Google login failed");
            return;
        }

        localStorage.setItem("token", result.data.access_token);
        localStorage.setItem("username", result.data.username);
        localStorage.setItem("role", result.data.role);

        if(result.data.role === "admin"){
            window.location.href = "/frontend/admin_dashboard.html";
        } else {
            window.location.href = "/frontend/dashboard.html";
        }
    });
}

/* Init Google button */
function initGoogleSSO(){
    if(!(window.google && google.accounts && google.accounts.id)){
        console.log("[GSI] Not ready, retrying‚Ä¶");
        return setTimeout(initGoogleSSO, 250);
    }

    google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleGoogleCredential
    });

    google.accounts.id.renderButton(
        document.getElementById("googleLoginBtn"),
        { theme:"outline", size:"large", width:"100%" }
    );

    console.log("[GSI] Google button rendered");
}

document.addEventListener("DOMContentLoaded", initGoogleSSO);

/* ==========================
 FORGOT PASSWORD (your full logic preserved)
========================== */

const forgotOverlay = document.getElementById("forgot-overlay");
const openForgotBtn = document.getElementById("open-forgot-btn");
const closeForgotBtn = document.getElementById("forgot-close");

const stepEmail = document.getElementById("fp-step-email");
const stepOtp = document.getElementById("fp-step-otp");
const stepPassword = document.getElementById("fp-step-password");

const inputEmail = document.getElementById("forgot-email");
const inputOtp = document.getElementById("forgot-otp");
const inputNew = document.getElementById("forgot-new-password");
const inputConfirm = document.getElementById("forgot-confirm-password");

function showForgot(){
  forgotOverlay.style.display="flex";
  stepEmail.style.display="block";
  stepOtp.style.display="none";
  stepPassword.style.display="none";
}
function closeForgot(){ forgotOverlay.style.display="none"; }

openForgotBtn.addEventListener("click", showForgot);
closeForgotBtn.addEventListener("click", closeForgot);

/* SEND OTP */
document.getElementById("forgot-send-otp").onclick = async function(){
  const email = inputEmail.value.trim();
  const res = await fetch(`${API_BASE_URL}/forgot-password`, {
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify({ email })
  });
  const json = await res.json();
  if(!res.ok){ alert(json.detail); return; }

  stepEmail.style.display="none";
  stepOtp.style.display="block";
};

/* VERIFY OTP */
document.getElementById("forgot-verify-otp").onclick = async function(){
  const email = inputEmail.value.trim();
  const otp = inputOtp.value.trim();

  const res = await fetch(`${API_BASE_URL}/verify-otp`, {
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify({ email, otp })
  });

  const json = await res.json();
  if(!res.ok){ alert(json.detail); return; }

  stepOtp.style.display="none";
  stepPassword.style.display="block";
};

/* RESET PASSWORD */
document.getElementById("forgot-reset-btn").onclick = async function(){
  const email = inputEmail.value.trim();
  const newPass = inputNew.value.trim();

  const res = await fetch(`${API_BASE_URL}/reset-password`, {
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body:JSON.stringify({ email, new_password:newPass })
  });

  const json = await res.json();
  if(!res.ok){ alert(json.detail); return; }

  alert("Password updated.");
  closeForgot();
};

</script>
</body>
</html>

<!-- frontend/user.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Modern Form - SCMXpertLite</title>
    <!-- Inline favicon to avoid browser 404 requests -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='2' fill='%23673AB7'/%3E%3Ctext x='50%25' y='55%25' font-size='10' text-anchor='middle' fill='white' font-family='Roboto,Arial'/%3E%3C/svg%3E">

    <!-- Fonts + libs -->
    <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,600' rel='stylesheet'>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.11.3/paper-full.min.js"></script>

    <!-- reCAPTCHA v2 with onload callback -->
    <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit" async defer></script>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        @charset "UTF-8";
        :root {
            --primary-color: #6ac4ee;
            --primary-dark: #0288D1;
            --secondary-color: #673AB7;
            --secondary-dark: #512DA8;
        }

        body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            width: 100%;
            font-family: "Roboto", sans-serif;
            box-sizing: border-box;
        }

        #back { width: 100%; height: 100%; position: absolute; z-index: -999; }
        .backRight { position: absolute; right: 0; width: 50%; height: 100%; background: #03A9F4; }
        .backLeft { position: absolute; left: 0; width: 50%; height: 100%; background: #8bd3f2ec; }

        /* Canvas should be behind everything */
        .canvas-back { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        #slideBox { width: 50%; height: 100%; position: absolute; margin-left: 50%; overflow: hidden;
            box-shadow: 0 14px 28px rgba(204,20,20,0.25), 0 10px 10px rgba(0,0,0,0.22); z-index: 5; }
        .topLayer { width: 200%; height: 100%; position: relative; left: -100%; }
        .left, .right { width: 50%; height: 100%; overflow-y: scroll; position: absolute; }
        .left { background:whitesmoke; left: 0; }
        .right { background: #f9f9f9; right: 0; }
        .content { display:flex; flex-direction:column; justify-content:center; min-height:100%; width:80%; margin:auto; }
        .content h2 { font-weight:300; font-size:2.6em; margin:0.2em 0 0.1em; }
        .left h2 { color: var(--primary-color); } .right h2 { color: var(--secondary-color); }

        .form-element { margin: 1.6em 0; }
        .form-stack { display:flex; flex-direction:column; }
        label { font-size:0.8em; text-transform:uppercase; }
        input { background-color:transparent; border:0; border-bottom:1px solid; padding:8px 1px; margin-top:0.1em; outline:none; font-size:1em; }
        .left input { color:#090808e4; border-bottom:1px solid #0e0d0d42; }
        .right input { color:#212121; border-bottom:1px solid #212121; }
        .password-wrapper { position:relative; display:flex; align-items:center; }
        .password-toggle { position:absolute; right:8px; background:none; border:none; cursor:pointer; font-size:1.2em; width:30px; height:30px; }

        button { padding:0.8em 1.2em; font-weight:600; text-transform:uppercase; font-size:1em; color:#1adbf1f3; border:0; cursor:pointer; border-radius:3px; transition:0.25s; margin-right:10px; }
        .signup { background: var(--primary-color); color:white; }
        .login { background: var(--secondary-color); color:white; }
        .off { background:none; box-shadow:none; color: var(--primary-dark); }

        /* ensure recaptcha visible above the canvas */
        .captcha-box { margin: 18px 0; display:flex; justify-content:center; z-index: 20; position: relative; }
        .google-wrapper { margin-top: 30px; display:flex; justify-content:center; z-index: 20; position: relative; }

        /* ========== Forgot Password full-page blurred overlay (Style 3) ========== */
        #forgot-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            align-items: center;
            justify-content: center;
            /* backdrop + blur */
            background: rgba(0,0,0,0.45);
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
        }

        #forgot-card {
            width: 380px;
            max-width: calc(100% - 40px);
            background: #fff;
            border-radius: 12px;
            padding: 22px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
            position: relative;
        }

        #forgot-card h3 { margin: 0 0 14px; text-align:center; color: var(--primary-dark); }

        #forgot-card input[type="email"],
        #forgot-card input[type="password"],
        #forgot-card input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            margin-top:6px;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }

        #forgot-close {
            position: absolute;
            right: 10px;
            top: 8px;
            font-size: 20px;
            background: none;
            border: none;
            cursor: pointer;
        }

        .fp-action {
            margin-top: 12px;
            width: 100%;
            padding: 10px;
            background: var(--primary-dark);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .fp-step { display: none; }
        .fp-step.active { display: block; }

        @media (max-width: 768px) {
            #slideBox { width: 80%; margin-left:20%;}
        }
    </style>
</head>
<body>
    <div id="back">
        <canvas id="canvas" class="canvas-back"></canvas>
        <div class="backRight"></div>
        <div class="backLeft"></div>
    </div>

    <div id="slideBox">
        <div class="topLayer">

            <!-- SIGNUP -->
            <div class="left" style="scrollbar-width:none;">
                <div class="content">
                    <h2>Sign Up</h2>
                    <form id="form-signup" method="post" novalidate>
                        <div class="form-element form-stack">
                            <label>Email</label>
                            <input id="email" type="email" name="email" required>
                        </div>

                        <div class="form-element form-stack">
                            <label>Username</label>
                            <input id="username-signup" type="text" name="username" required>
                        </div>

                        <div class="form-element form-stack">
                            <label>Password</label>
                            <div class="password-wrapper">
                                <input id="password-signup" type="password" name="password" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('password-signup')">üëÅÔ∏è</button>
                            </div>
                        </div>

                        <div class="form-element form-stack">
                            <label>Confirm Password</label>
                            <div class="password-wrapper">
                                <input id="confirm-password-signup" type="password" name="confirm-password" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('confirm-password-signup')">üëÅÔ∏è</button>
                            </div>
                        </div>

                        <!-- reCAPTCHA container (v2 checkbox) -->
                        <div class="captcha-box">
                            <div id="recaptcha-signup"></div>
                        </div>

                        <div class="form-element">
                            <button class="signup" type="submit" onclick="submitSignupForm(event)">Sign Up</button>
                            <button id="goLeft" class="signup off" type="button">Log In</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- LOGIN -->
            <div class="right" style="scrollbar-width:none;">
                <div class="content">
                    <h2>Login</h2>
                    <form id="form-login" method="post" novalidate>
                        <div class="form-element form-stack">
                            <label>Username or Email</label>
                            <input id="username-login" type="text" name="username" required>
                        </div>

                        <div class="form-element form-stack">
                            <label>Password</label>
                            <div class="password-wrapper">
                                <input id="password-login" type="password" name="password" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('password-login')">üëÅÔ∏è</button>
                            </div>
                        </div>

                        <!-- reCAPTCHA container (v2 checkbox) -->
                        <div class="captcha-box">
                            <div id="recaptcha-login"></div>
                        </div>

                        <div class="form-element">
                            <button class="login" type="submit" onclick="submitLoginForm(event)">Log In</button>
                            <button id="goRight" class="login off" type="button">Sign Up</button>
                        </div>

                        <!-- Forgot Password link (Option A: below Login button) -->
                        <div style="text-align:center;margin-top:10px;">
                            <button id="open-forgot" type="button" style="background:none;border:none;color:#0288D1;cursor:pointer;">
                                Forgot Password?
                            </button>
                        </div>

                        <!-- Google Sign-In -->
                        <div class="google-wrapper">
                            <div id="googleLoginBtn"></div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <!-- ========== FORGOT PASSWORD OVERLAY (Full-page blurred) ========== -->
    <div id="forgot-overlay" aria-hidden="true">
        <div id="forgot-card" role="dialog" aria-modal="true" aria-labelledby="forgot-title">
            <button id="forgot-close" aria-label="Close">‚úï</button>
            <h3 id="forgot-title">Reset Password</h3>

            <!-- Step 1: Email -->
            <div id="fp-step-email" class="fp-step active">
                <label for="forgot-email">Enter your email</label>
                <input id="forgot-email" type="email" placeholder="you@example.com" autocomplete="email">

                <button id="forgot-send-otp" class="fp-action">Send OTP</button>
            </div>

            <!-- Step 2: OTP -->
            <div id="fp-step-otp" class="fp-step">
                <label for="forgot-otp">Enter the 6-digit OTP</label>
                <input id="forgot-otp" type="text" maxlength="6" placeholder="123456" inputmode="numeric" pattern="[0-9]*">

                <button id="forgot-verify-otp" class="fp-action">Verify OTP</button>
            </div>

            <!-- Step 3: New Password -->
            <!-- Step 3: New Password -->
           <div id="fp-step-password" class="fp-step">

           <label for="forgot-new-password">New password</label>
           <div style="position: relative; margin-bottom: 12px;">
           <input id="forgot-new-password" 
               type="password" 
               placeholder="New Password"
               autocomplete="new-password"
               style="width: 100%; padding: 10px 40px 10px 10px; border-radius: 8px; border: 1px solid #ddd;">
        
              <span onclick="togglePassword('forgot-new-password', this)"
              style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">
               üëÅÔ∏è
              </span>
              </div>

              <label for="forgot-confirm-password" style="margin-top:10px;">Confirm password</label>
              <div style="position: relative; margin-bottom: 12px;">
              <input id="forgot-confirm-password" 
               type="password" 
               placeholder="Confirm Password"
               autocomplete="new-password"
               style="width: 100%; padding: 10px 40px 10px 10px; border-radius: 8px; border: 1px solid #ddd;">
        
               <span onclick="togglePassword('forgot-confirm-password', this)"
              style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">
               üëÅÔ∏è
             </span>
             </div>

              <button id="forgot-reset-btn" class="fp-action">Reset Password</button>
             </div>

        </div>
    </div>

<script>
/* ========== CONFIG ========== */
const API_BASE_URL = `${location.protocol}//${location.hostname}:8000`;
const GOOGLE_CLIENT_ID = "192553672532-6d99lu2hh454bmb9i5muf8g4si7ib6b3.apps.googleusercontent.com";
const RECAPTCHA_SITE_KEY = "6Lc6sROsAAAAAismO1rlx89SHD9kgzFPqOPukMMJ";

/* ===== helpers ===== */
function togglePassword(id){
    const f = document.getElementById(id); f.type = f.type === "password" ? "text" : "password";
}
/* Fixed sliding: animate left property (not marginLeft) */
$("#goRight").click(()=>$(".topLayer").animate({ left: "0" }));    // show SIGNUP
$("#goLeft").click(()=>$(".topLayer").animate({ left: "-100%" })); // show LOGIN

function saveAuth(data){
    if(data?.access_token) localStorage.setItem("token", data.access_token);
    if(data?.username) localStorage.setItem("username", data.username);
    if(data?.role) localStorage.setItem("role", data.role);
}

function redirectByUsername(username){
    // Prefer role-based redirect when available
    const role = localStorage.getItem("role") || "user";
    if(role === "admin") {
        window.location.href = "/frontend/admin_dashboard.html";
        return;
    }
    // Fallback: if username specifically should map to admin
    if(String(username || "").toLowerCase() === "meghana") {
        window.location.href = "/frontend/admin_dashboard.html";
        return;
    }
    window.location.href = "/frontend/dashboard.html";
}

/* ======================
   CLEAN reCAPTCHA LOADER
====================== */

let recaptchaSignupWidget = null;
let recaptchaLoginWidget = null;
let recaptchaInitInterval = null;

// Google calls this automatically once api.js loads
function onRecaptchaLoad() {
    console.log("[reCAPTCHA] onRecaptchaLoad ‚Üí library ready");
    startRecaptchaInit();
}

function startRecaptchaInit() {
    if (recaptchaInitInterval) return;

    recaptchaInitInterval = setInterval(() => {
        if (!window.grecaptcha || !grecaptcha.render) {
            console.log("[reCAPTCHA] Waiting for grecaptcha...");
            return;
        }

        console.log("[reCAPTCHA] grecaptcha loaded ‚Üí rendering widgets");
        clearInterval(recaptchaInitInterval);

        renderRecaptchaWidgets();
    }, 150);
}

function renderRecaptchaWidgets() {
    // SIGNUP widget
    if (!recaptchaSignupWidget && document.getElementById("recaptcha-signup")) {
        recaptchaSignupWidget = grecaptcha.render("recaptcha-signup", {
            sitekey: RECAPTCHA_SITE_KEY,
            theme: "light"
        });
        console.log("[reCAPTCHA] Signup widget rendered:", recaptchaSignupWidget);
    }

    // LOGIN widget
    if (!recaptchaLoginWidget && document.getElementById("recaptcha-login")) {
        recaptchaLoginWidget = grecaptcha.render("recaptcha-login", {
            sitekey: RECAPTCHA_SITE_KEY,
            theme: "light"
        });
        console.log("[reCAPTCHA] Login widget rendered:", recaptchaLoginWidget);
    }
}

// Start checking if reCAPTCHA loads
startRecaptchaInit();

/* ===== SIGNUP (manual) ===== */
function submitSignupForm(event){
    event.preventDefault();
    console.log("[Signup] Form submitted");
    
    const email = $("#email").val().trim();
    const username = $("#username-signup").val().trim();
    const password = $("#password-signup").val().trim();
    const confirm_password = $("#confirm-password-signup").val().trim();
    
    if(!email || !username || !password || !confirm_password){
        alert("Please fill in all fields");
        return;
    }
    
    if(password !== confirm_password){
        alert("Passwords do not match");
        return;
    }

    let token = "";
    
    // Try to get reCAPTCHA token if available
    if(typeof grecaptcha !== "undefined" && recaptchaSignupWidget !== null && recaptchaSignupWidget !== undefined){
        token = grecaptcha.getResponse(recaptchaSignupWidget);
        console.log("[Signup] reCAPTCHA token obtained:", !!token);
    }

    const payload = new URLSearchParams({
        username,
        email,
        password,
        confirm_password,
        recaptcha_token: token
    });

    console.log("[Signup] Sending POST to", `${API_BASE_URL}/signup`);

    fetch(`${API_BASE_URL}/signup`, {
        method: "POST",
        body: payload
    })
    .then(async r => {
        console.log("[Signup] Response status:", r.status);
        if(!r.ok) {
            const err = await r.json().catch(()=>({detail:"Signup failed"}));
            throw new Error(err.detail || "Signup failed");
        }
        return r.json();
    })
    .then(data => {
        console.log("[Signup] Signup successful");
        alert("Signup successful. Please login.");
        if(typeof grecaptcha !== "undefined" && recaptchaSignupWidget !== null && recaptchaSignupWidget !== undefined){
            grecaptcha.reset(recaptchaSignupWidget);
        }
        $("#form-signup")[0].reset();
        $(".topLayer").animate({ left: "-100%" });
    })
    .catch(err => {
        console.error("[Signup] Error:", err);
        alert(err.message || "Signup error");
        if(typeof grecaptcha !== "undefined" && recaptchaSignupWidget !== null && recaptchaSignupWidget !== undefined){
            grecaptcha.reset(recaptchaSignupWidget);
        }
    });
}

$("#form-signup").submit(function(e){
    e.preventDefault();
    submitSignupForm(e);
});

/* ===== LOGIN (manual) ===== */
function submitLoginForm(event){
    event.preventDefault();
    console.log("[Login] Form submitted - event triggered");
    
    const username = $("#username-login").val().trim();
    const password = $("#password-login").val().trim();
    
    console.log("[Login] Attempting login with username:", username, "password length:", password.length);
    
    if(!username || !password){
        alert("Please enter username and password");
        return;
    }

    // Get reCAPTCHA token if available, otherwise use empty string
    let token = "";
    if(typeof grecaptcha !== "undefined" && recaptchaLoginWidget !== null && recaptchaLoginWidget !== undefined){
        token = grecaptcha.getResponse(recaptchaLoginWidget);
        console.log("[Login] reCAPTCHA token obtained:", !!token);
        
        if(!token){ 
            console.warn("[Login] User has not completed reCAPTCHA checkbox - will try with empty token");
            // Don't return - allow submission with empty token
        }
    } else {
        console.warn("[Login] reCAPTCHA not available - proceeding with empty token");
    }

    const payload = new URLSearchParams({
        username,
        password,
        recaptcha_token: token
    });

    console.log("[Login] Sending POST to", `${API_BASE_URL}/login`);
    
    fetch(`${API_BASE_URL}/login`, {
        method: "POST",
        body: payload
    })
    .then(async r => {
        console.log("[Login] Response status:", r.status);
        const body = await r.json().catch(()=>({}));
        if(!r.ok) {
            const errMsg = body.detail || "Login failed";
            console.error("[Login] Error response:", errMsg);
            throw new Error(errMsg);
        }
        return body;
    })
    .then(data => {
        console.log("[Login] Login successful!");
        saveAuth(data);
        redirectByUsername(data.username || username);
    })
    .catch(err => {
        console.error("[Login] Request failed:", err.message);
        alert("Login failed: " + (err.message || "Unknown error"));
    })
    .finally(()=> {
        if(typeof grecaptcha !== "undefined" && recaptchaLoginWidget !== null && recaptchaLoginWidget !== undefined){
            grecaptcha.reset(recaptchaLoginWidget);
        }
    });
}

$("#form-login").submit(function(e){
    e.preventDefault();
    submitLoginForm(e);
});

/* ===== GOOGLE SSO (GSI) ===== */
function initGSI(){
    if(!window.google || !google.accounts || !google.accounts.id){
        console.warn("GSI not loaded");
        return;
    }

    google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleGoogleCredential,
        auto_select: false,
        cancel_on_tap_outside: true
    });

    google.accounts.id.renderButton(
        document.getElementById("googleLoginBtn"),
        { theme: "outline", size: "large", type: "standard" }
    );
}

function decodeJwtPayload(jwt){
    try{
        const parts = jwt.split('.');
        const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
        return payload;
    }catch(e){
        return null;
    }
}

async function handleGoogleCredential(response){
    const idToken = response?.credential;
    if(!idToken){
        alert("Google login failed");
        return;
    }

    // collect reCAPTCHA token (try login widget)
    let recaptcha_token = "";
    if(recaptchaLoginWidget && grecaptcha.getResponse){
        recaptcha_token = grecaptcha.getResponse(recaptchaLoginWidget);
    }

    try{
        const res = await fetch(`${API_BASE_URL}/auth/google`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: idToken, recaptcha_token })
        });

        const data = await res.json().catch(()=>({}));
        if(res.ok && data?.access_token){
            saveAuth(data);
            redirectByUsername(data.username || decodeJwtPayload(idToken)?.email);
            return;
        } else {
            // backend didn't accept -> fallback decode and RBAC redirect
            const payload = decodeJwtPayload(idToken);
            const email = payload?.email || payload?.sub || "";
            redirectByUsername(email);
            return;
        }
    }catch(err){
        console.warn("Google auth POST failed, falling back:", err);
        const payload = decodeJwtPayload(idToken);
        const email = payload?.email || payload?.sub || "";
        redirectByUsername(email);
    }
}

/* ========== FORGOT PASSWORD POPUP LOGIC (ADDED) ========== */
(function(){
    // Cache DOM elements
    const forgotOverlay = document.getElementById('forgot-overlay');
    const openForgotBtn = document.getElementById('open-forgot');
    const closeForgotBtn = document.getElementById('forgot-close');

    const stepEmail = document.getElementById('fp-step-email');
    const stepOtp = document.getElementById('fp-step-otp');
    const stepPassword = document.getElementById('fp-step-password');

    const inputEmail = document.getElementById('forgot-email');
    const inputOtp = document.getElementById('forgot-otp');
    const inputNewPwd = document.getElementById('forgot-new-password');
    const inputConfirmPwd = document.getElementById('forgot-confirm-password');

    const btnSendOtp = document.getElementById('forgot-send-otp');
    const btnVerifyOtp = document.getElementById('forgot-verify-otp');
    const btnReset = document.getElementById('forgot-reset-btn');

    function showOverlay(){
        forgotOverlay.style.display = 'flex';
        // reset UI
        stepEmail.classList.add('active');
        stepOtp.classList.remove('active');
        stepPassword.classList.remove('active');
        inputEmail.value = '';
        inputOtp.value = '';
        inputNewPwd.value = '';
        inputConfirmPwd.value = '';
        inputEmail.focus();
    }

    function hideOverlay(){
        forgotOverlay.style.display = 'none';
    }

    // Open / close
    if(openForgotBtn) openForgotBtn.addEventListener('click', showOverlay);
    if(closeForgotBtn) closeForgotBtn.addEventListener('click', hideOverlay);
    if(forgotOverlay) {
        forgotOverlay.addEventListener('click', function(e){
            if(e.target === forgotOverlay) hideOverlay();
        });
    }

    // OTP input: only digits, max 6
    if(inputOtp){
        inputOtp.addEventListener('input', function(){
            this.value = this.value.replace(/\D/g, '').slice(0,6);
        });
    }

    // STEP 1: Send OTP
    if(btnSendOtp){
        btnSendOtp.addEventListener('click', async function(){
            const email = (inputEmail.value || '').trim();
            if(!email){
                alert('Please enter your email');
                inputEmail.focus();
                return;
            }

            try{
                const res = await fetch(`${API_BASE_URL}/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                if(!res.ok){
                    const d = await res.json().catch(()=>({ detail: 'Failed to send OTP' }));
                    throw new Error(d.detail || 'Failed to send OTP');
                }

                alert('OTP sent to your email. Please check your inbox.');
                // show OTP step
                stepEmail.classList.remove('active');
                stepOtp.classList.add('active');
                inputOtp.focus();
            }catch(err){
                console.error('Send OTP error', err);
                alert(err.message || 'Network error while sending OTP');
            }
        });
    }

    // STEP 2: Verify OTP
    if(btnVerifyOtp){
        btnVerifyOtp.addEventListener('click', async function(){
            const email = (inputEmail.value || '').trim();
            const otp = (inputOtp.value || '').trim();

            if(!otp || otp.length < 4){
                alert('Please enter the OTP sent to your email');
                inputOtp.focus();
                return;
            }

            try{
                const res = await fetch(`${API_BASE_URL}/verify-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp })
                });

                if(!res.ok){
                    const d = await res.json().catch(()=>({ detail: 'Invalid OTP' }));
                    throw new Error(d.detail || 'Invalid OTP');
                }

                alert('OTP verified. Please enter your new password.');
                stepOtp.classList.remove('active');
                stepPassword.classList.add('active');
                inputNewPwd.focus();
            }catch(err){
                console.error('Verify OTP error', err);
                alert(err.message || 'Invalid OTP');
            }
        });
    }

    // STEP 3: Reset Password
    if(btnReset){
        btnReset.addEventListener('click', async function(){
            const email = (inputEmail.value || '').trim();
            const p1 = (inputNewPwd.value || '').trim();
            const p2 = (inputConfirmPwd.value || '').trim();

            if(!p1 || !p2){
                alert('Please enter and confirm your new password');
                return;
            }
            if(p1 !== p2){
                alert('Passwords do not match');
                return;
            }

            try{
                const res = await fetch(`${API_BASE_URL}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, new_password: p1 })
                });

                if(!res.ok){
                    const d = await res.json().catch(()=>({ detail: 'Password reset failed' }));
                    throw new Error(d.detail || 'Password reset failed');
                }

                alert('Password has been updated. You may now login.');
                hideOverlay();
            }catch(err){
                console.error('Reset password error', err);
                alert(err.message || 'Failed to reset password');
            }
        });
    }

    // close on ESC
    document.addEventListener('keydown', function(e){
        if(e.key === 'Escape' && forgotOverlay.style.display === 'flex'){
            hideOverlay();
        }
    });
})();
/* ========== END FORGOT PASSWORD POPUP LOGIC ========== */

</script>

<!-- Paper.js animation (unchanged visual behavior) -->
<script>
(function(){
    paper.install(window);
    paper.setup(document.getElementById("canvas"));

    const shapeGroup = new paper.Group();
    let positionArray = [];

    function getCanvasBounds() {
        const canvasWidth = view.size.width;
        const canvasHeight = view.size.height;
        const centerX = canvasWidth / 2;
        const centerY = canvasHeight / 2;

        positionArray = [
            { x: centerX - 50, y: 150 },
            { x: 200, y: centerY },
            { x: canvasWidth - 130, y: canvasHeight - 75 },
            { x: 0, y: centerY + 100 },
            { x: centerX / 2 + 100, y: 100 },
            { x: centerX + 80, y: canvasHeight - 50 },
            { x: canvasWidth + 60, y: centerY - 50 },
            { x: centerX + 100, y: centerY + 100 }
        ];
    }

    function initializeShapes() {
        getCanvasBounds();
        const bubbleSizes = [30, 25, 40, 20, 35, 28, 32, 22];
        for (let i = 0; i < 8; i++) {
            new Path.Circle({
                center: positionArray[i],
                radius: bubbleSizes[i],
                fillColor: i % 2 ? "rgba(103, 58, 183, 0.3)" : "rgba(3, 169, 244, 0.3)",
                strokeColor: i % 2 ? "rgba(103, 58, 183, 0.6)" : "rgba(3, 169, 244, 0.6)",
                strokeWidth: 2,
                parent: shapeGroup
            });
        }
    }

    initializeShapes();

    view.onFrame = (event) => {
        if (event.count % 4 === 0) {
            shapeGroup.children.forEach((bubble, i) => {
                bubble.scale(1 + 0.15 * Math.sin(event.count * 0.05 + i));
            });
        }
    };

    view.onResize = () => {
        getCanvasBounds();
        shapeGroup.children.forEach((b, i) => b.position = positionArray[i]);
    };
})();
</script>
</body>
</html>

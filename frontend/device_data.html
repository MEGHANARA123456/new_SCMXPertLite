<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Device Data Stream</title>

<style>
/* ===== GLOBAL SMOOTH ANIMATION ===== */
* {
  transition: all 0.25s ease;
}

/* Fade-in effect for cards & table rows */
.card, .table tr {
  animation: fadeIn 0.6s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Hover lift animation for cards */
.card:hover {
  transform: translateY(-4px);
  box-shadow: 0px 10px 28px rgba(0,0,0,0.12);
}

/* ===== TOP NAVIGATION ===== */
.topbar {
  width: 100%;
  background: linear-gradient(90deg, #6C27D9, #9c4dff);
  padding: 16px 20px;
  position: sticky;
  top: 0;
  z-index: 10;
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
}

.nav-menu {
  display: flex;
  gap: 35px;
  justify-content: center;
  font-size: 18px;
}

.nav-menu a {
  text-decoration: none;
  color: white;
  font-weight: 500;
  position: relative;
}

.nav-menu a::after {
  content: '';
  position: absolute;
  width: 0%;
  height: 2px;
  background: #ffffff;
  left: 0;
  bottom: -4px;
  transition: 0.3s;
}

.nav-menu a:hover::after {
  width: 100%;
}

/* ===== INPUT FIELDS ===== */
#deviceForm .input,
#deviceForm select {
  border: 2px solid #b9b9b9;
  border-radius: 8px;
  padding: 10px;
  font-size: 15px;
  background: #f8faff;
}

#deviceForm .input:focus,
#deviceForm select:focus {
  border-color: #00aaff;
  box-shadow: 0 0 8px rgba(0,170,255,0.4);
  transform: scale(1.03);
}

/* ===== BUTTON ===== */
#deviceForm .btn-primary {
  background: linear-gradient(90deg, #03A9F4, #0288D1);
  border: none;
  border-radius: 10px;
  padding: 12px 26px;
  color: white;
  font-weight: 600;
  letter-spacing: 0.4px;
  cursor: pointer;
}

#deviceForm .btn-primary:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0px 8px 18px rgba(3,169,244,0.4);
}

/* ===== TABLE STYLING ===== */
.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 15px;
}

.table th {
  background: linear-gradient(90deg, #e8f1ff, #f0f7ff);
  padding: 12px;
  text-align: left;
  font-weight: 700;
  border-bottom: 2px solid #d7d7d7;
  color: #333;
}

.table td {
  padding: 12px;
  border-bottom: 1px solid #ececec;
  color: #444;
}

/* row hover glow */
.table tr:hover {
  background: #f0f6ff;
  box-shadow: inset 0 0 8px rgba(0,150,255,0.1);
  transform: scale(1.01);
}

/* ===== CARDS ===== */
.card {
  border-radius: 18px;
  padding: 24px;
  background: #ffffff;
  box-shadow: 0px 6px 18px rgba(0,0,0,0.08);
}

/* top card styling */
.card[style*="background: #a7dfff"] {
  background: linear-gradient(180deg, #a7dfff, #d5f0ff) !important;
  border-radius: 18px;
  box-shadow: 0px 8px 22px rgba(0,0,0,0.1);
}

/* Titles */
.container h2 {
  color: #222;
  font-weight: 700;
  animation: fadeIn 0.8s ease;
}

/* Responsive */
@media (max-width: 768px) {
  #deviceForm .grid {
    flex-direction: column !important;
    gap: 14px !important;
  }

  #deviceForm .field {
    width: 100% !important;
  }
}
</style>

</head>

<body>

<header class="topbar">
  <nav class="nav-menu">
    <a href="/frontend/user.html">My Account</a>
    <a href="/frontend/shipments.html">My Shipments</a>
    <a href="/frontend/shipment_data.html">Create Shipment</a>
    <a href="/frontend/logout.html">logout</a>
  </nav>
</header>

<div class="container">

  <h2 style="text-align:center; font-weight:700; margin-top:10px;">
    Device Data Stream
  </h2>

  <!-- Top card -->
  <div class="card" style="margin-top:24px; background: #a7dfff; padding:40px; text-align:center;">

    <h3 style="margin-top:0; font-weight:600;">
      Please Enter a Device Id to See the Data Stream
    </h3>

    <form id="deviceForm" style="margin-top:20px;">
      <div class="grid cols-2" style="display:flex; gap:20px; justify-content:center; align-items:center;">

        <!--  Manual Input Instead of Dropdown -->
        <div class="field" style="width:250px; margin:auto;">
          <label>Device Id*</label>
          <input type="text" id="device_id" class="input" placeholder="Enter Device ID or leave blank to view recent" >
        </div>

        <!-- Submit Button -->
        <div style="margin:auto;">
          <button type="submit" class="btn btn-primary" style="padding:12px 26px; font-size:14px;">
            GET DEVICE DATA
          </button>
        </div>

      </div>
    </form>

  </div>

  <!-- Data table -->
  <div class="card" style="margin-top:26px;">
    <table class="table">
      <thead>
        <tr>
          <th>Device Id</th>
          <th>Battery Level</th>
          <th>Temperature</th>
          <th>Route From</th>
          <th>Route To</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody id="streamData">
        <tr><td colspan="6" style="text-align:center;" class="small">No data loaded</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>
const API_URL = `${location.protocol}//${location.hostname}:8000`;
let selectedDevice = null;
let autoRefreshTimer = null;

// Helper: show a friendly row message
function showMessage(msg) {
    const tbody = document.getElementById("streamData");
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;" class="small">${msg}</td></tr>`;
}

// Format timestamp (fallback to raw if invalid)
function formatTimestamp(ts) {
    try {
        const d = new Date(ts);
        if (isNaN(d)) return ts || "";
        return d.toLocaleString();
    } catch { return ts || ""; }
}

// ------------------------
// FIXED WORKING loadStream()
// ------------------------
async function loadStream() {
    const tbody = document.getElementById("streamData");
    tbody.innerHTML = "";
    showMessage("Loading...");

    // SELECT ENDPOINT CORRECTLY
    let endpoint;
    if (selectedDevice) {
        endpoint = `${API_URL}/device-data/${selectedDevice}`;
    } else {
        endpoint = `${API_URL}/device-data/recent`;
    }

    console.log("[Device Data] Fetching from:", endpoint);

    try {
        const res = await fetch(endpoint);
        if (!res.ok) {
            if (res.status === 404) {
                showMessage("No data found");
                return;
            }
            showMessage("Error loading data");
            console.error("[Device Data] Fetch error", res.status, await res.text());
            return;
        }

        const data = await res.json();
        console.log("[Device Data] Response:", data);
        
        const records = data.records || data;

        if (!records || records.length === 0) {
            showMessage("No data found");
            return;
        }

        console.log("[Device Data] Got", records.length, "records");

        tbody.innerHTML = "";
        records.forEach(row => {
            const deviceId = row.Device_ID ?? row.device_id ?? "N/A";
            const battery = row.Battery_Level ?? row.battery_level ?? "N/A";
            const temperature = row.First_Sensor_temperature ?? row.first_sensor_temperature ?? "N/A";
            const routeFrom = row.Route_From ?? row.route_from ?? "N/A";
            const routeTo = row.Route_To ?? row.route_to ?? "N/A";
            const timestamp = formatTimestamp(row.timestamp);

            tbody.innerHTML += `
                <tr>
                    <td>${deviceId}</td>
                    <td>${battery}</td>
                    <td>${temperature}</td>
                    <td>${routeFrom}</td>
                    <td>${routeTo}</td>
                    <td>${timestamp}</td>
                </tr>
            `;
        });

    } catch (err) {
        console.error("[Device Data] Error:", err);
        showMessage("Error loading data: " + err.message);
    }
}

// Handle input submit
document.getElementById("deviceForm").addEventListener("submit", (e) => {
    e.preventDefault();
    selectedDevice = document.getElementById("device_id").value.trim();

    console.log("[Device Data] Device ID entered:", selectedDevice);

    loadStream();

    if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    autoRefreshTimer = setInterval(loadStream, 20000);  // 20 seconds
});

// Auto load last 50 on page load
window.addEventListener("load", () => {
    console.log("[Device Data] Page loaded, fetching initial data...");
    
    selectedDevice = "";
    loadStream();

    if (autoRefreshTimer) clearInterval(autoRefreshTimer);
    autoRefreshTimer = setInterval(loadStream, 20000); // 20 seconds
});
</script>


</body>
</html>

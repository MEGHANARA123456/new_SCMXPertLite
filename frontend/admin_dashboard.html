<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SCMXpertLite — Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,600" rel="stylesheet">
<style>
  /* ===== Palette & base (matches your UI, updated visuals) ===== */
  :root{
    --purple:#673AB7;
    --purple-dark:#4A1CA0;
    --purple-soft:#7c52d0;
    --teal:#03C2E0;
    --bg:#f3f1fb;
    --panel:#ffffff;
    --muted:#666;
    --success:#2ecc71;
    --danger:#e74c3c;
    --accent:#6ac4ee;
    --shadow: 0 8px 28px rgba(46,17,84,0.06);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family:Roboto,system-ui,Arial;
    margin:0;
    background: linear-gradient(135deg, rgba(124,82,208,0.04), rgba(230,226,245,0.04)), #f8f6fb;
    color:#222;
    -webkit-font-smoothing:antialiased;
  }

  a{color:inherit}

  /* topbar */
  .topbar{
    width:100%;
    background:var(--purple);
    padding:12px 20px;
    box-shadow:0 3px 12px rgba(0,0,0,0.08);
    position:sticky; top:0; z-index:40;
  }
  .nav-menu{display:flex; gap:18px; align-items:center; justify-content:flex-start}
  .nav-menu a{color:#fff; text-decoration:none; font-weight:600; font-size:14px}
  .brand{display:flex;align-items:center;gap:12px;color:#fff}

  /* layout */
  .layout{
    display:flex;
    max-width:1200px;
    margin:28px auto;
    gap:24px;
    padding:0 16px;
  }

  /* Glass sidebar (purple-tinted) */
  .sidebar{
    width:260px;
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
    border-radius:14px;
    padding:14px;
    color:#111;
    backdrop-filter: blur(8px) saturate(120%);
    -webkit-backdrop-filter: blur(8px) saturate(120%);
    box-shadow: 0 18px 40px rgba(88,40,160,0.08);
    border:1px solid rgba(255,255,255,0.12);
  }
  .sidebar h3{margin:0 0 12px; font-size:16px; color:#111(255,255,255,0.95)}
  .menu-item{
    display:flex; flex-direction:column; justify-content:space-between; align-items:flex-start;
    padding:12px 10px; border-radius:8px; cursor:pointer;
    color:#111(255,255,255,0.88); margin-bottom:8px; transition:all .14s ease;
    background: linear-gradient(180deg, rgba(124,82,208,0.06), rgba(255,255,255,0.01));
  }
  .menu-item:hover{ transform:translateX(4px); }
  .menu-item.active{ background: rgba(255,255,255,0.12); }
  .menu-item small{ color: #111(255,255,255,0.7); font-weight:400; margin-top:6px; display:block }

  .main{flex:1}
  .panel{
    background:var(--panel);
    border-radius:12px;
    padding:18px;
    box-shadow:0 6px 22px rgba(0,0,0,0.06);
    margin-bottom:18px;
    transition:all .12s ease;
  }

  .header-row{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px}
  .title{font-size:20px; color:var(--purple); font-weight:700}
  .controls{display:flex; gap:8px; align-items:center}

  .small{font-size:13px;color:var(--muted)}
  .muted{color:var(--muted)}

  /* tables */
  table{width:100%; border-collapse:collapse}
  th,td{padding:12px 10px; text-align:left; border-bottom:1px solid #f0f0f3; font-size:14px}
  th{font-weight:600; color:#444}
  .user-table tbody tr:hover{background:#fbfbff}
  .role-badge{padding:6px 10px; border-radius:999px; background:#f3f0ff; color:var(--purple); font-weight:700; font-size:13px; display:inline-block}

  .btn{padding:9px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:700; transition:all .12s ease}
  .btn.primary{background:var(--purple); color:#fff}
  .btn.ghost{background:transparent; border:1px solid #eee; color:#222}
  .btn.warn{background:var(--teal); color:#042}
  .btn.icon{display:inline-flex; align-items:center; gap:8px; padding:8px 10px}
  .actions button{margin-right:6px}

  /* two column grid */
  .grid{display:grid; grid-template-columns:1fr 420px; gap:18px}
  @media (max-width:980px){ .layout{margin:12px} .grid{grid-template-columns:1fr} .sidebar{display:none} }

  /* modal */
  .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:1000; opacity:0; pointer-events:none; transition:all .18s ease}
  .modal-backdrop.show{opacity:1; pointer-events:auto}
  .modal{width:760px; max-width:96%; background:var(--panel); border-radius:12px; padding:18px; box-shadow:0 18px 60px rgba(30,12,60,0.18)}
  .modal h4{margin:0 0 8px; color:var(--purple)}
  .close-btn{background:#eee; border-radius:8px; padding:6px 8px; border:0; cursor:pointer}

  /* permissions grid */
  .perm-grid{width:100%; border-collapse:collapse; margin-top:12px}
  .perm-grid th,.perm-grid td{padding:10px; border:1px solid #f0eff6; text-align:center}
  .perm-grid th{background:#fbf8ff; color:var(--purple); font-weight:700}
  .chip.yes{background:var(--success); color:white; padding:6px 8px; border-radius:8px}
  .chip.no{background:var(--danger); color:white; padding:6px 8px; border-radius:8px}

  /* toast */
  #toast{
    position:fixed; top:22px; left:50%; transform:translateX(-50%) translateY(-26px);
    background:var(--purple); color:#fff; padding:12px 18px; border-radius:10px; box-shadow:0 10px 30px rgba(102,20,170,0.18);
    opacity:0; transition:all .28s ease; z-index:1200;
  }
  #toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  /* tiny helpers */
  .muted-block{color:var(--muted); font-size:13px}
  .search{padding:8px 10px; border-radius:8px; border:1px solid #eee; width:100%}
  .flex{display:flex; gap:8px; align-items:center}
  .gap{height:12px}

  /* small UI niceties */
  .hidden { display:none !important; opacity:0; transform:translateY(-6px) }
  .fade-in { animation: fadeInUp .18s ease both }
  @keyframes fadeInUp { from { opacity:0; transform:translateY(6px) } to { opacity:1; transform:translateY(0) } }

  /* logged-in list */
  .logged-list { margin-top:10px; border-radius:8px; padding:10px; background:rgba(255,255,255,0.06); font-size:13px; max-height:160px; overflow:auto; color:#111(255,255,255,0.95) }
  .logout-btn { background:transparent; border-radius:8px; border:1px solid rgba(255,255,255,0.12); color:#fff; padding:8px 10px; cursor:pointer }
  .logout-btn svg { vertical-align:middle }

  /* action menu icon */
  .three-dots { width:28px; height:28px; border-radius:6px; background:#f6f6fb; display:inline-flex; align-items:center; justify-content:center; cursor:pointer }

  /* Right-side Reply Drawer */
  .reply-drawer {
    width:320px;
    background:var(--panel);
    border-radius:12px;
    padding:14px;
    box-shadow:0 10px 40px rgba(30,12,60,0.12);
    position:fixed;
    right:20px;
    bottom:24%;
    z-index:1200;
    transform: translateX(420px);
    transition: transform 260ms cubic-bezier(.2,.9,.2,1), opacity 260ms;
    opacity:0;
  }
  .reply-drawer.open { transform: translateX(0); opacity:1; }
  .reply-drawer h4 { margin:0 0 8px; color:var(--purple); }
  .reply-drawer textarea { width:100%; min-height:110px; padding:10px; border-radius:8px; border:1px solid #eee; resize:vertical; }

  /* slide-right + fade animation for rows */
  .animate-out { animation: slideFadeRight 460ms ease forwards; }
  @keyframes slideFadeRight {
    from { transform: translateX(0); opacity: 1; }
    to   { transform: translateX(50px); opacity: 0; height:0; margin:0; padding:0; }
  }

  /* Floating Request FAB (same as design) */
  .request-fab{position:fixed;right:22px;bottom:22px;background:var(--purple);color:#fff;padding:12px 16px;border-radius:999px;box-shadow:0 10px 30px rgba(103,58,183,0.2);cursor:pointer;z-index:1200}
  .drawer{position:fixed;right:22px;bottom:80px;width:360px;background:#fff;border-radius:10px;padding:12px;box-shadow:0 16px 40px rgba(20,10,40,0.12);display:none;z-index:1200}
  .drawer.open{display:block}
  .drawer h4{margin:0 0 8px}
  .drawer textarea{width:100%;height:100px;border:1px solid #eee;border-radius:8px;padding:8px;resize:vertical}
  .drawer .row{display:flex;gap:8px;margin-top:8px}
  .drawer select, .drawer input{padding:8px;border-radius:8px;border:1px solid #eee;width:100%}

  /* bottom-left toast (fallback small) */
  #smallToast { position: fixed; left: 16px; bottom: 16px; min-width:220px; background:#111;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 8px 26px rgba(0,0,0,0.2); opacity:0; transform: translateY(8px); transition: all 260ms ease; z-index:2000; }
  #smallToast.show{ opacity:1; transform: translateY(0); }

  .badge { display:inline-block;padding:6px 8px;border-radius:6px;background:#f1f1f1;color:#333;font-weight:700;font-size:12px }
</style>
</head>
<body>

  <header class="topbar">
    <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:18px;">
      <div class="brand"><strong style="font-size:18px">SCMXpertLite</strong> <span style="opacity:.85;font-size:13px;margin-left:8px">Admin</span></div>
      <nav class="nav-menu" style="margin-left:18px">
        <a href="/frontend/user.html">My Account</a>
        <a href="/frontend/device_data.html">live streaming</a>
        <a href="/frontend/dashboard.html">Dashboard</a>
        <a href="/frontend/shipments.html">Shipments</a>
        <a href="/frontend/shipment_data.html">create Shipments</a>
      </nav>

      <div style="margin-left:auto; display:flex; gap:12px; align-items:center;">
        <div style="color:#fff; font-weight:600">Welcome — <span id="currentAdmin">...</span></div>
        <button id="logoutBtn" class="logout-btn" title="Logout">
          <!-- logout icon -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px" xmlns="http://www.w3.org/2000/svg">
            <path d="M16 17L21 12L16 7" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M21 12H9" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M13 19H6C5.44772 19 5 18.5523 5 18V6C5 5.44772 5.44772 5 6 5H13" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Logout
        </button>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <h3>Admin Tools</h3>

      <div id="menuUsers" class="menu-item active" data-section="users">
        Users
        <small>manage accounts</small>
      </div>

      <div id="menuRequests" class="menu-item" data-section="requests">
        Pending Requests
        <small>access requests</small>
      </div>

      <div id="menuRoles" class="menu-item" data-section="roles">
        Roles & Permissions
        <small>edit roles</small>
      </div>

      <div id="menuAudit" class="menu-item" data-section="audit">
        Audit & Logs
        <small>history</small>
      </div>

      <div style="margin-top:12px">
        <div class="small muted">Logged in sessions</div>
        <div id="loggedList" class="logged-list"></div>
      </div>
    </aside>

    <main class="main">
      <div class="grid">

        <!-- LEFT: Main content area -->
        <div>
          <!-- USERS PANEL -->
          <section id="panelUsers" class="panel hidden fade-in">
            <div class="header-row">
              <div>
                <div class="title">Team Members</div>
                <div class="small">Active users in the system — assign roles & permissions</div>
              </div>

              <div class="controls">
                <input id="userSearch" class="search" placeholder="Search users by name or email" />
                <button class="btn primary" id="refreshAll">Refresh</button>
                <button class="btn ghost" id="btnShowRequests">Show Requests</button>
              </div>
            </div>

            <div style="overflow:auto">
              <table class="user-table" id="usersTable">
                <thead>
                  <tr><th>Username</th><th>Email</th><th>Role</th><th>Admin</th><th>Actions</th></tr>
                </thead>
                <tbody id="usersList">
                  <!-- filled by JS -->
                </tbody>
              </table>
            </div>
          </section>

          <!-- PENDING REQUESTS PANEL (prominent on load) -->
          <!-- NOTE: Title column was added per your request (1.b) -->
          <section id="panelRequests" class="panel fade-in">
            <div class="header-row">
              <div>
                <div class="title">Pending Admin Requests</div>
                <div class="small">Users requesting elevated access</div>
              </div>
              <div class="controls">
                <input id="requestsFilter" class="search" placeholder="Filter username or title..." />
                <button class="btn ghost" id="refreshRequests">Refresh</button>
              </div>
            </div>

            <div style="overflow:auto">
              <table id="requestsTable">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Username</th>
                    <th>Requested At</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody><!-- filled by JS --></tbody>
              </table>
            </div>
          </section>

          <!-- AUDIT PANEL -->
          <section id="panelAudit" class="panel hidden fade-in">
            <div class="header-row">
              <div>
                <div class="title">Audit & Logs</div>
                <div class="small">Activity & admin actions</div>
              </div>
              <div class="controls">
                <button class="btn ghost" id="refreshAudit">Refresh</button>
              </div>
            </div>

            <div style="overflow:auto">
              <table id="auditTable">
                <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
                <tbody><!-- filled by JS with either real audit logs or fallback --></tbody>
              </table>
            </div>
          </section>
        </div>

        <!-- RIGHT: Quick tools + replies -->
        <aside>
          <section class="panel">
            <div class="header-row">
              <div>
                <div class="title">Quick Tools</div>
                <div class="small">Open panels & quick actions</div>
              </div>
            </div>

            <div style="margin-top:8px; display:flex; flex-direction:column; gap:8px;">
              <button id="btnTeamMembers" class="btn primary">Team Members</button>
              <button id="btnEditRoles" class="btn ghost">Edit Roles</button>
              <button id="btnShowPendingFull" class="btn warn">Show Pending Requests (Full)</button>

              <div class="gap"></div>
              <div class="muted-block">Permissions preview</div>
              <table class="perm-grid" id="permGrid">
                <thead>
                  <tr><th>Permission</th><th>Admin</th><th>Manager</th><th>Editor</th><th>Viewer</th></tr>
                </thead>
                <tbody>
                  <tr><td>View Dashboard</td><td><span class="chip yes">✓</span></td><td><span class="chip yes">✓</span></td><td><span class="chip yes">✓</span></td><td><span class="chip yes">✓</span></td></tr>
                  <tr><td>Export Users</td><td><span class="chip yes">✓</span></td><td><span class="chip yes">✓</span></td><td><span class="chip no">✕</span></td><td><span class="chip no">✕</span></td></tr>
                  <tr><td>Manage Shipments</td><td><span class="chip yes">✓</span></td><td><span class="chip yes">✓</span></td><td><span class="chip no">✕</span></td><td><span class="chip no">✕</span></td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- REQUEST REPLIES (list of replies sent) -->
          <section class="panel" id="requestRepliesPanel" aria-live="polite" style="margin-top:14px;">
            <div class="header-row">
              <div>
                <div class="title">Request Replies</div>
                <div class="small">Recent replies you've sent</div>
              </div>
            </div>
            <div id="repliesList" style="max-height:260px; overflow:auto; font-size:13px;">
              <div class="muted">No replies yet</div>
            </div>
          </section>
        </aside>

      </div>
    </main>
  </div>

  <!-- Role modal -->
  <div id="roleModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h4>Edit Team Member Role</h4>
        <button class="close-btn" id="closeModal">Close</button>
      </div>

      <div style="margin-top:12px">
        <div class="muted-block">User: <strong id="modalUsername">—</strong></div>
        <div class="muted-block">Email: <span id="modalUserEmail">—</span></div>

        <div style="margin-top:12px">
          <label style="display:block;margin-bottom:8px">Role</label>
          <select id="modalRoleSelect" class="search">
            <option value="">-- choose role --</option>
            <option value="admin">Admin</option>
            <option value="manager">Manager</option>
            <option value="editor">Editor</option>
            <option value="viewer">Viewer</option>
            <option value="user">User</option>
          </select>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
          <button class="btn ghost" id="modalCancel">Cancel</button>
          <button class="btn primary" id="modalSave">Save Role</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating FAB and Drawer (request sending) -->
  <button id="fabRequest" class="request-fab">+ Request</button>

  <div id="drawer" class="drawer" aria-hidden="true">
    <h4>Send request to admin</h4>
    <label class="small">Type</label>
    <select id="request-type"><option value="shipments">Shipments</option><option value="users">Users</option><option value="device-data">Device Data</option></select>
    <label class="small" style="margin-top:8px">Title</label>
    <input id="request-title" placeholder="Short title"/>
    <label class="small" style="margin-top:8px">Description</label>
    <textarea id="request-desc" placeholder="Describe what you need..."></textarea>
    <div class="row" style="margin-top:8px">
      <button id="sendRequestBtn" class="btn primary" style="flex:1">Send Request</button>
      <button id="closeDrawer" class="btn ghost" style="flex:1">Close</button>
    </div>
  </div>

  <!-- Right-side Reply Drawer (RB1) -->
  <div id="replyDrawer" class="reply-drawer" aria-hidden="true">
    <h4>Reply to Request</h4>
    <div style="font-size:13px;color:#444;margin-bottom:8px">
      <div><strong id="replyReqTitle">—</strong></div>
      <div style="color:var(--muted); font-size:12px" id="replyReqMeta">—</div>
    </div>
    <textarea id="replyText" placeholder="Write your message to the user..."></textarea>
    <div style="display:flex; gap:8px; margin-top:10px">
      <button id="sendReplyBtn" class="btn primary" style="flex:1">Send Reply</button>
      <button id="closeReplyBtn" class="btn ghost" style="flex:1">Close</button>
    </div>
  </div>

  <div id="toast"></div>
  <div id="smallToast"></div>

<script>
/* ============================================================
   BASE HELPERS & CONSTANTS
   - small changes: requests table uses request._id (string)
============================================================ */
const API = `${location.protocol}//${location.hostname}:8000`;

function getToken() { return localStorage.getItem("token") || ""; }

function authHeaders() {
  const t = getToken();
  return t ? { "Authorization": "Bearer " + t } : {};
}

function decodeToken() {
  const t = getToken();
  if (!t) return null;
  try { return JSON.parse(atob(t.split(".")[1])); }
  catch { return null; }
}

function fmt(dt) {
  try { return new Date(dt).toLocaleString(); }
  catch { return dt; }
}

const toast = document.getElementById("toast");
function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2600);
}

function escapeHtml(s) {
  if (!s) return "";
  return String(s).replace(/[&<>"']/g, t => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[t]));
}

/* ============================================================
   POPULATE CURRENT ADMIN
============================================================ */
const decoded = decodeToken();
document.getElementById("currentAdmin").textContent =
  (decoded && (decoded.username || decoded.sub)) || "admin";

/* ============================================================
   PANEL TOGGLING (unchanged)
============================================================ */
const panelUsers = document.getElementById("panelUsers");
const panelRequests = document.getElementById("panelRequests");
const panelAudit = document.getElementById("panelAudit");

function hidePanels() {
  panelUsers.classList.add("hidden");
  panelRequests.classList.add("hidden");
  panelAudit.classList.add("hidden");
}

document.getElementById("menuUsers").onclick = () => {
  hidePanels();
  panelUsers.classList.remove("hidden");
};

document.getElementById("menuRequests").onclick = () => {
  hidePanels();
  panelRequests.classList.remove("hidden");
};

document.getElementById("menuAudit").onclick = () => {
  hidePanels();
  panelAudit.classList.remove("hidden");
};

document.getElementById("btnTeamMembers").onclick = () => {
  hidePanels();
  panelUsers.classList.remove("hidden");
};

document.getElementById("btnShowPendingFull").onclick = () => {
  hidePanels();
  panelRequests.classList.remove("hidden");
};

document.getElementById("btnShowRequests").onclick = () => {
  hidePanels();
  panelRequests.classList.remove("hidden");
};

/* ============================================================
   LOGOUT
============================================================ */
document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("token");
  showToast("Logged out");
  setTimeout(() => (window.location.href = "/frontend/user.html"), 700);
};

/* ============================================================
   LOAD PENDING REQUESTS (updated to include Title column
   and to render dataset attributes: data-id and data-json)
============================================================ */
async function loadRequests() {
  const tbody = document.querySelector("#requestsTable tbody");
  tbody.innerHTML = `<tr><td colspan="5">Loading...</td></tr>`;

  try {
    const res = await fetch(`${API}/admin/pending`, { headers: authHeaders() });
    if (!res.ok) {
      tbody.innerHTML = `<tr><td colspan="5">Failed to load</td></tr>`;
      return;
    }
    const data = await res.json();
    let arr = data.requests || data || [];

    if (!Array.isArray(arr)) arr = [];

    if (arr.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5">No pending requests</td></tr>`;
      return;
    }

    // Render rows: add data-id (request id string) and include title column
    tbody.innerHTML = arr
      .map(r => {
        const rid = r._id || r.request_id || "";
        const title = r.title || r.type || "(no title)";
        const status = r.status || "pending";
        // escape JSON safely for dataset usage
        const jsonSafe = JSON.stringify(r).replace(/'/g,"&#39;").replace(/</g,"&lt;");
        return `
        <tr data-id="${escapeHtml(String(rid))}" data-json='${jsonSafe}'>
          <td>${escapeHtml(title)}</td>
          <td>${escapeHtml(r.username || '')}</td>
          <td>${fmt(r.requested_at)}</td>
          <td class="status-cell">${escapeHtml(status)}</td>
          <td>
            <button class="btn primary" data-approve="${escapeHtml(String(rid))}">Approve</button>
            <button class="btn ghost" data-reject="${escapeHtml(String(rid))}">Reject</button>
            <button class="btn ghost" data-reply="${escapeHtml(String(rid))}">Reply</button>
          </td>
        </tr>`;
      })
      .join("");
  } catch (err) {
    console.error(err);
    tbody.innerHTML = `<tr><td colspan="5">Error loading requests</td></tr>`;
  }
}

/* ============================================================
   APPROVE / REJECT / OPEN REPLY — updated to use request_id
============================================================ */
document.addEventListener("click", async e => {
  const approveId = e.target.dataset.approve;
  if (approveId) return approveRequest(approveId);

  const rejectId = e.target.dataset.reject;
  if (rejectId) return rejectRequest(rejectId);

  const replyId = e.target.dataset.reply;
  if (replyId) return openReplyDrawer(replyId);

  // edit buttons etc handled below as before
});

async function approveRequest(request_id) {
  try {
    const res = await fetch(`${API}/admin/requests/${encodeURIComponent(request_id)}/approve`, {
      method: "POST",
      headers: { ...authHeaders(), "Content-Type": "application/json" },
      body: "{}"
    });
    if (!res.ok) { showToast("Approve failed"); return; }
    showToast("Approved");
    await loadRequests();
    await loadReplies();
  } catch (err) {
    console.error(err);
    showToast("Approve failed");
  }
}

async function rejectRequest(request_id) {
  try {
    const res = await fetch(`${API}/admin/requests/${encodeURIComponent(request_id)}/reject`, {
      method: "POST",
      headers: { ...authHeaders(), "Content-Type": "application/json" },
      body: "{}"
    });
    if (!res.ok) { showToast("Reject failed"); return; }
    showToast("Rejected");
    await loadRequests();
    await loadReplies();
  } catch (err) {
    console.error(err);
    showToast("Reject failed");
  }
}

/* ============================================================
   REPLY DRAWER + SEND REPLY
   - uses POST /admin/requests/{request_id}/reply
   - on success: mark row status = "resolved" in UI, refresh lists
   - replies panel refreshed (formatted as requested)
============================================================ */
const replyDrawer = document.getElementById("replyDrawer");
const replyTitle = document.getElementById("replyReqTitle");
const replyMeta = document.getElementById("replyReqMeta");
const replyMsg = document.getElementById("replyText");
let currentReplyRequestId = null;

function openReplyDrawer(request_id) {
  const tr = document.querySelector(`tr[data-id="${CSS.escape(request_id)}"]`);
  if (!tr) return showToast("Request not found");

  const data = JSON.parse(tr.dataset.json || "{}");
  currentReplyRequestId = request_id;

  replyTitle.textContent = data.title || data.type || "User Request";
  replyMeta.textContent = `${data.username || "user"} • ${fmt(data.requested_at)}`;

  replyMsg.value = "";
  replyDrawer.classList.add("open");
}

document.getElementById("closeReplyBtn").onclick = () =>
  replyDrawer.classList.remove("open");

document.getElementById("sendReplyBtn").onclick = async () => {
  const text = replyMsg.value.trim();
  if (!text) return showToast("Write a reply");

  if (!currentReplyRequestId) return showToast("No request selected");

  const payload = { reply: text };

  try {
    const res = await fetch(`${API}/admin/requests/${encodeURIComponent(currentReplyRequestId)}/reply`, {
      method: "POST",
      headers: { ...authHeaders(), "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=>"");
      console.error("Reply failed:", res.status, txt);
      return showToast("Reply failed");
    }

    showToast("Reply sent");

    // Mark the row status 'resolved' in the UI immediately
    const tr = document.querySelector(`tr[data-id="${CSS.escape(currentReplyRequestId)}"]`);
    if (tr) {
      const statusCell = tr.querySelector(".status-cell");
      if (statusCell) statusCell.textContent = "resolved";
    }

    // Optionally attempt to persist status change server-side if endpoint exists.
    // NOTE: backend currently doesn't have /admin/requests/{id}/resolve — below call is safe to attempt and ignored if 404.
    fetch(`${API}/admin/requests/${encodeURIComponent(currentReplyRequestId)}/resolve`, {
      method: "POST",
      headers: { ...authHeaders(), "Content-Type": "application/json" },
      body: JSON.stringify({}),
    }).catch(()=>{}); // ignore error if not implemented

    replyDrawer.classList.remove("open");
    replyMsg.value = "";

    await loadReplies();
    await loadRequests();
  } catch (err) {
    console.error(err);
    showToast("Reply failed");
  }
};
/* ============================================================
   FIXED LOAD REPLIES (right-side panel)
============================================================ */
async function loadReplies() {
  const box = document.getElementById("repliesList");
  box.innerHTML = `<div>Loading...</div>`;

  try {
    const res = await fetch(`${API}/admin/replies`, { headers: authHeaders() });
    const data = await res.json();

    console.log("Replies from backend:", JSON.stringify(data, null, 2));

    const list = data.replies || [];

    if (!list.length) {
      box.innerHTML = `<div>No replies yet</div>`;
      return;
    }

    box.innerHTML = list.map(r => {
      const title = r.request_title || "(no title)";
      const replyText = r.reply || "";
      const admin = r.admin || "admin";
      const sentAt = r.sent_at ? fmt(r.sent_at) : "";

      return `
        <div style="padding:10px 0; border-bottom:1px solid #f0f0f3">
          <div style="font-weight:700; color:var(--purple)">
            Title: ${escapeHtml(title)}
          </div>

          <div style="margin-top:6px">
            Reply: ${escapeHtml(replyText)}
          </div>

          <div style="font-size:12px; color:#666; margin-top:6px">
            Sent by ${escapeHtml(admin)} at ${sentAt}
          </div>
        </div>
      `;
    }).join("");

  } catch (err) {
    console.error("Replies load error:", err);
    box.innerHTML = `<div>Error loading replies</div>`;
  }
}


/* ============================================================
   LOAD USERS  (uses /admin/users)
============================================================ */
async function loadUsers() {
  const tbody = document.getElementById("usersList");
  tbody.innerHTML = `<tr><td colspan="5">Loading...</td></tr>`;

  try {
    const res = await fetch(`${API}/admin/users`, { headers: authHeaders() });
    if (!res.ok) {
      tbody.innerHTML = `<tr><td colspan="5">Error loading users</td></tr>`;
      return;
    }

    const data = await res.json();
    const users = data.users || [];

    if (users.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5">No users found</td></tr>`;
      return;
    }

    tbody.innerHTML = users.map(u => `
      <tr>
        <td>${escapeHtml(u.username)}</td>
        <td>${escapeHtml(u.email || "(no email)")}</td>
        <td><span class="role-badge">${escapeHtml(u.role)}</span></td>
        <td>${u.role === "admin" ? "Yes" : "No"}</td>
        <td>
          <button class="btn ghost"
            data-edit="${escapeHtml(u.username)}"
            data-role="${escapeHtml(u.role)}"
            data-email="${escapeHtml(u.email || "")}">
            Edit
          </button>
        </td>
      </tr>
    `).join("");

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="5">Error loading users</td></tr>`;
  }
}
/* ============================================================
   ROLE MODAL + /admin/set-role/{username}
============================================================ */
const roleModal = document.getElementById("roleModal");
const modalUsername = document.getElementById("modalUsername");
const modalUserEmail = document.getElementById("modalUserEmail");
const modalRoleSelect = document.getElementById("modalRoleSelect");

document.getElementById("modalCancel").onclick =
document.getElementById("closeModal").onclick = () =>
  roleModal.classList.remove("show");

document.addEventListener("click", e => {
  if (e.target.dataset.edit) {
    const user = e.target.dataset.edit;
    const role = e.target.dataset.role;
    const email = e.target.dataset.email;

    modalUsername.textContent = user;
    modalUserEmail.textContent = email || "(no email)";
    modalRoleSelect.value = role;

    roleModal.classList.add("show");
  }
});

document.getElementById("modalSave").onclick = async () => {
  const username = modalUsername.textContent;
  const role = modalRoleSelect.value;

  if (!role) return showToast("Choose a role");

  try {
    const res = await fetch(`${API}/admin/set-role/${encodeURIComponent(username)}`, {
      method: "POST",
      headers: { ...authHeaders(), "Content-Type": "application/json" },
      body: JSON.stringify({ role })
    });

    if (!res.ok) return showToast("Update failed");

    showToast("Role updated");
    roleModal.classList.remove("show");
    loadUsers();
    document.getElementById("panelUsers").classList.remove("hidden");

  } catch {
    showToast("Update failed");
  }
};

/* ============================================================
   AUDIT LOGS (fallback mock for now)
============================================================ */
async function loadAudit() {
  const tbody = document.querySelector("#auditTable tbody");
  tbody.innerHTML = `<tr><td colspan="4">Loading...</td></tr>`;

  try {
    const mock = [
      { time: Date.now(), user: "admin", action: "Approved", details: "User promoted" }
    ];
    tbody.innerHTML = mock
      .map(m => `
        <tr>
          <td>${fmt(m.time)}</td>
          <td>${m.user}</td>
          <td>${m.action}</td>
          <td>${m.details}</td>
        </tr>`)
      .join("");
  } catch {
    tbody.innerHTML = `<tr><td colspan="4">Error</td></tr>`;
  }
}

/* ============================================================
   REQUEST DRAWER + /requests
============================================================ */
const fabRequest = document.getElementById("fabRequest");
const drawer = document.getElementById("drawer");
const closeDrawer = document.getElementById("closeDrawer");
const sendRequestBtn = document.getElementById("sendRequestBtn");

fabRequest.onclick = () => drawer.classList.toggle("open");
closeDrawer.onclick = () => drawer.classList.remove("open");

sendRequestBtn.onclick = async () => {
  const type = document.getElementById("request-type").value;
  const title = document.getElementById("request-title").value.trim();
  const desc = document.getElementById("request-desc").value.trim();

  if (!title || !desc) return showToast("Fill all fields");

  try {
    const res = await fetch(`${API}/requests`, {
      method: "POST",
      headers: { ...authHeaders(), "Content-Type": "application/json" },
      body: JSON.stringify({ type, title, description: desc })
    });

    if (!res.ok) return showToast("Failed");

    showToast("Request sent");
    drawer.classList.remove("open");
    loadRequests();
  } catch {
    showToast("Failed");
  }
};

/* ============================================================
   LOGGED SESSION HANDLING
============================================================ */
function getSessions() {
  try { return JSON.parse(localStorage.getItem("scmx_sessions") || "[]"); }
  catch { return []; }
}
function saveSessions(arr) {
  localStorage.setItem("scmx_sessions", JSON.stringify(arr));
}

function updateLoggedList() {
  const list = document.getElementById("loggedList");
  const arr = getSessions();
  if (!arr.length) {
    list.innerHTML = "<div>No sessions</div>";
    return;
  }
  list.innerHTML = arr
    .map(s => `
      <div style="padding:6px 8px;background:rgba(255,255,255,0.12);border-radius:8px;margin-bottom:8px;">
        <div><strong>${escapeHtml(s.username)}</strong></div>
        <div style="font-size:12px">${fmt(s.ts)}</div>
      </div>`)
    .join("");
}
function addSession() {
  const u = (decodeToken() && (decodeToken().username || decodeToken().sub)) || "guest";
  const arr = getSessions().filter(s => s.username !== u);
  arr.unshift({ username: u, ts: new Date().toISOString() });
  saveSessions(arr.slice(0, 20));
  updateLoggedList();

  fetch(`${API}/admin/loggedin`, {
    method: "POST",
    headers: { ...authHeaders(), "Content-Type": "application/json" },
    body: JSON.stringify({ username: u, ts: new Date().toISOString() })
  }).catch(() => {});
}

/* ============================================================
   INIT LOAD
============================================================ */
loadRequests();
loadUsers();
loadAudit();
loadReplies();
addSession();

document.getElementById("refreshAll").onclick = () => {
  loadRequests();
  loadUsers();
  loadAudit();
  loadReplies();
};
document.getElementById("refreshRequests").onclick = loadRequests;
document.getElementById("refreshAudit").onclick = loadAudit;

document.getElementById("userSearch").oninput = e => {
  const q = e.target.value.toLowerCase();
  document.querySelectorAll("#usersTable tbody tr").forEach(tr => {
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? "" : "none";
  });
};
document.getElementById("requestsFilter").oninput = e => {
  const q = e.target.value.toLowerCase();
  document.querySelectorAll("#requestsTable tbody tr").forEach(tr => {
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? "" : "none";
  });
};
</script>
</body>
</html>

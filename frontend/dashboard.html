<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SCMXPertLite â€” Dashboard</title>

  <!-- keep your stylesheet -->
  <link rel="stylesheet" href="/frontend/style.css">

  <style>
    /* --- small inline styles to match your UI --- */
    body{font-family:Roboto,Arial,Helvetica,sans-serif;margin:0}
    .topbar{height:64px;background:#673AB7;color:#fff;display:flex;align-items:center;padding:0 18px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
    .nav-menu a{color:white;margin-right:18px;text-decoration:none;font-weight:600}
    .welcome{padding:28px;text-align:center;font-size:28px;color: #673AB7;font-weight:700}
    .split-bg{display:flex;height:420px}
    .left-side,.right-side{flex:1;display:flex;align-items:center;justify-content:center}
    .left-side{background:#bfe9ff}
    .right-side{background:#e9cfff}
    .box-content{text-align:center}
    .btn-blue{display:inline-block;background:#0aa1ff;color:white;padding:12px 26px;border-radius:24px;text-decoration:none;font-weight:800}
    .btn-purple{display:inline-block;background:#7a33c7;color:white;padding:12px 26px;border-radius:24px;text-decoration:none;font-weight:800}

    /* Floating Request button */
    #requestAccessBtn {
      position: fixed;
      bottom: 22px;
      right: 22px;
      background: linear-gradient(135deg,#6a11cb,#2575fc);
      color: #fff;
      border:none;padding:12px 14px;border-radius:999px;box-shadow:0 8px 30px rgba(103,58,183,0.25);cursor:pointer;z-index:9999;
    }

    /* Modal */
    #requestModalOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:99999}
    #requestModal{width:420px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 20px 40px rgba(0,0,0,0.3)}
    #requestDescription{width:100%;height:120px;border:1px solid #ddd;border-radius:8px;padding:10px;resize:vertical}

    /* small toast */
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#222;color:#fff;padding:12px 18px;border-radius:8px;opacity:0;transition:all .24s;z-index:999999}
    #toast.show{opacity:1}

    /* replies box (bottom-right) */
    #replyBox{
      position:fixed;
      bottom:110px;
      right:28px;
      width:320px;
      max-height:300px;
      overflow:auto;
      background:#fff;
      border-radius:12px;
      padding:14px;
      box-shadow:0 18px 60px rgba(20,10,40,0.12);
      z-index:1200;
      display:none;
    }
    .replyItem{background:#f8f6ff;border-radius:8px;padding:10px;margin-bottom:10px;box-shadow:0 2px 6px rgba(0,0,0,0.04)}
    .replyItem time{display:block;color:#666;font-size:12px;margin-bottom:6px}
  </style>
</head>
<body>

  <header class="topbar">
    <nav class="nav-menu" style="display:flex;align-items:center;">
      <a href="/frontend/user.html">My Account</a>
      <a href="/frontend/shipments.html">My Shipments</a>
      <a href="/frontend/shipment_data.html">create Shipments</a>
      <a href="/frontend/device_data.html">live streaming</a>
      <a href="/frontend/logout.html">logout</a>
    </nav>
  </header>

  <div class="welcome" id="welcomeText">Hi user, Welcome to SCMXPertLite</div>

  <div class="split-bg">
    <div class="left-side">
      <div class="box-content">
        <h2>Create a New Shipment</h2>
        <p>Start tracking by creating your shipment.</p>
        <a href="/frontend/shipment_data.html" class="btn-blue" id="createShipmentBtn">CREATE SHIPMENT</a>
      </div>
    </div>
    <div class="right-side">
      <div class="box-content">
        <h2>To see Device Data Stream</h2>
        <p>Monitor your real-time device activity.</p>
        <a href="/frontend/device_data.html" class="btn-purple">DEVICE DATA STREAM</a>
      </div>
    </div>
  </div>

  <!-- Floating Request Button -->
  <button id="requestAccessBtn">Request Access</button>

  <!-- Request Modal -->
  <div id="requestModalOverlay">
    <div id="requestModal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0;color:#5a1bb3">Request Access</h3>
        <button id="closeModal" title="Close" style="background:transparent;border:0;font-size:18px;cursor:pointer">&times;</button>
      </div>

      <p style="color:#555;margin:0 0 8px 0">Describe the access you need (Shipments, Users, Device Data, Live streaming, etc.)</p>
      <textarea id="requestDescription" placeholder="Type your request..."></textarea>
      <button id="submitRequestBtn" style="width:100%;margin-top:12px;background:linear-gradient(135deg,#6a11cb,#2575fc);color:#fff;border:none;padding:12px;border-radius:8px;font-weight:700;cursor:pointer">Submit</button>
    </div>
  </div>

  <!-- Replies Box (user) -->
  <div id="replyBox" aria-live="polite">
    <div style="font-weight:700;color:#673AB7;font-size:16px;margin-bottom:6px">Replies</div>
    <div style="font-size:13px;color:#777;margin-bottom:8px">Admin responses</div>
    <div id="replyBoxList"></div>
  </div>

  <div id="toast"></div>

<script>
/* ============================
   Config & helpers
   ============================ */
const API_BASE_URL = `${location.protocol}//${location.hostname}:8000`;
function getToken(){ return localStorage.getItem("token") || ""; }
function authHeaders(){ const t=getToken(); return t ? { "Authorization":"Bearer "+t } : {}; }
function decodeToken(){ try{ const t=getToken(); if(!t) return null; return JSON.parse(atob(t.split('.')[1])); }catch{return null;} }

function showToast(msg, t = 3000){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=> el.classList.remove("show"), t);
}

/* Welcome text */
document.addEventListener("DOMContentLoaded", () => {
  const p = decodeToken();
  if (p) {
    const username = p.username || p.sub || "";
    const role = (p.role || "user").toUpperCase();

    document.getElementById("welcomeText").innerHTML = `
      Hi <span class="welcome-username">${username}</span> (${role}), Welcome to SCMXPertLite. Ready to dive in?`;
  }
});

/* ===== Request Modal ===== */
const requestBtn = document.getElementById("requestAccessBtn");
const modalOverlay = document.getElementById("requestModalOverlay");
const closeModal = document.getElementById("closeModal");
const submitBtn = document.getElementById("submitRequestBtn");

requestBtn.onclick = () => modalOverlay.style.display = "flex";
closeModal.onclick = () => modalOverlay.style.display = "none";
modalOverlay.onclick = (e) => { if(e.target === modalOverlay) modalOverlay.style.display = "none"; };

submitBtn.onclick = async () => {
  const desc = document.getElementById("requestDescription").value.trim();
  if(!desc) { showToast("Please enter a request"); return; }

  // try two endpoints for compatibility: /requests and /admin/request-access
  const payload = { description: desc };

  try {
    let res = await fetch(`${API_BASE_URL}/requests`, {
      method: "POST",
      headers: Object.assign({ "Content-Type": "application/json" }, authHeaders()),
      body: JSON.stringify({ type: "user_request", description: desc })
    });

    if(!res.ok){
      // fallback to older endpoint if present
      res = await fetch(`${API_BASE_URL}/admin/request-access`, {
        method: "POST",
        headers: Object.assign({ "Content-Type": "application/json" }, authHeaders()),
        body: JSON.stringify({ description: desc })
      });
    }

    const j = await res.json().catch(()=>({}));
    if(!res.ok) { showToast(j.detail || j.message || "Request failed"); return; }

    showToast("Request submitted!");
    document.getElementById("requestDescription").value = "";
    modalOverlay.style.display = "none";
  } catch(err){
    console.error(err);
    showToast("Network error");
  }
};

/* ===== Replies (user) =====
   - loadReplies() fetches /user/replies
   - poll for new replies every 4s
*/
let lastReplyTime = 0;

async function loadReplies(){
  const box = document.getElementById("replyBox");
  const list = document.getElementById("replyBoxList");
  try {
    const res = await fetch(`${API_BASE_URL}/user/replies`, { headers: authHeaders() });
    if(!res.ok){
      // hide box if endpoint not available or 403
      box.style.display = "none";
      return;
    }
    const data = await res.json();
    const replies = data.replies || [];

    if(!replies.length){
      box.style.display = "none";
      return;
    }

    // render reversed (most recent top)
    const rendered = replies.slice().reverse().map(r => {
      const ts = r.sent_at ? new Date(r.sent_at).toLocaleString() : '';
      const msg = escapeHtml(r.message || r.reply || '');
      return `<div class="replyItem"><time>${escapeHtml(ts)}</time><div>${msg}</div></div>`;
    }).join("");

    list.innerHTML = rendered;
    box.style.display = "block";

    // update lastReplyTime
    const latest = new Date(replies[replies.length-1]?.sent_at || 0).getTime();
    if(latest && latest > lastReplyTime) lastReplyTime = latest;

  } catch(err) {
    console.error("loadReplies error", err);
  }
}

async function pollReplies(){
  try {
    const res = await fetch(`${API_BASE_URL}/user/replies`, { headers: authHeaders() });
    if(!res.ok) return;
    const data = await res.json();
    const replies = data.replies || [];
    if(!replies.length) return;
    const latest = new Date(replies[replies.length-1].sent_at || 0).getTime();
    if(latest > lastReplyTime){
      if(lastReplyTime !== 0){
        showToast("New reply from Admin!");
      }
      lastReplyTime = latest;
      loadReplies();
    }
  } catch(e){
    // silent
  }
}

/* small helper to escape html */
function escapeHtml(str){
  if(str === undefined || str === null) return '';
  return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}

/* init */
loadReplies();
setInterval(pollReplies, 4000);
</script>

</body>
</html>
